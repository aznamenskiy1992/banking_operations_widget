# Виджет банковских операций

## Цель проекта:
- Виджет может использоваться для банковских сервисов
- Он показывает несколько последних успешных операций клиента.

## Установка
1. Убедитесь, то у вас установлен Poetry. Если нет:
```
pip install --user poetry
```
2. Создайте виртуальное окружение
```
poetry install
```
3. Клонируйте репозиторий
```
git clone https://github.com/aznamenskiy1992/banking_operations_widget.git
```

## Тестирование
Проект включает комплексные тесты для всех основных функций. Для запуска тестов используйте:
```
pytest tests/ -v
```

### Описание тестовых сценариев

#### Тестирование функций маскировки:
1. `test_mask_card_number` - проверяет корректность маскировки номеров карт:
   - Разные длины номеров (13, 16, 18, 19 цифр)
   - Обработка некорректных данных (None, строки с символами, другие типы данных)
   
2. `test_mask_account` - проверяет маскировку номеров счетов:
   - Корректные 20-значные номера
   - Некорректные форматы (короткие/длинные номера)

3. `test_mask_account_card` - проверяет автоматическое определение типа номера:
   - Распознавание карт разных платежных систем
   - Распознавание счетов с разными вариантами написания ("Счет"/"Счёт")
   - Обработка сложных форматов строк

#### Тестирование работы с датами:
1. `test_get_date` - проверяет преобразование форматов дат:
   - Корректное преобразование ISO-формата в "ДД.ММ.ГГГГ"
   - Обработка строк с пробелами
   - Реакция на некорректные данные

#### Тестирование обработки операций:
1. `test_filter_by_state` - проверяет фильтрацию операций:
   - Фильтрация по статусам "EXECUTED" и "CANCELED"
   - Обработка отсутствующего ключа 'state'
   - Реакция на несуществующие статусы

2. `test_sort_by_date` - проверяет сортировку операций:
   - Сортировка по возрастанию и убыванию
   - Обработка случаев отсутствия ключа 'date'
   - Корректность порядка сортировки

#### Тестирование фильтрации по валюте:
1. `test_filter_by_currency` - проверяет фильтрацию транзакций по валюте:
   - Корректная фильтрация по коду валюты (USD, EUR и др.)
   - Регистронезависимое сравнение валют
   - Обработка отсутствующих ключей в словарях транзакций
   - Реакция на некорректные входные данные (None, пустые списки, неверные типы)

2. `test_none_list_for_filter_by_currency` - проверяет обработку None вместо списка транзакций
3. `test_empty_transactions_list` - проверяет обработку пустого списка транзакций
4. `test_currency_not_str` - проверяет обработку нестроковых значений валюты

#### Тестирование извлечения описаний:
1. `test_get_transaction_info` - проверяет извлечение описаний транзакций:
   - Корректное извлечение поля "description"
   - Пропуск транзакций без описания
   - Обработка некорректных входных данных

#### Тестирование генератора номеров карт:
1. `test_generate_card_number` - проверяет генерацию номеров карт:
   - Корректное форматирование (XXXX XXXX XXXX XXXX)
   - Дополнение ведущими нулями
   - Обработка граничных значений
2. `test_start_stop_validation` - проверяет валидацию параметров:
   - Проверка на None
   - Проверка типов (int)
   - Проверка диапазона (0 < start ≤ stop ≤ 9999999999999999)

#### Тестирование декоратора логирования:
1. `test_log_success_operation_in_file_for_get_mask_card_number_with_log_decorator` - проверяет логирование успешной операции в файл
2. `test_log_success_operation_in_console_for_get_mask_card_number_with_log_decorator` - проверяет логирование успешной операции в консоль
3. `test_log_success_operation_in_file_for_filter_by_state_with_log_decorator` - проверяет логирование успешной фильтрации в файл
4. `test_log_success_operation_in_console_for_filter_by_state_with_log_decorator` - проверяет логирование успешной фильтрации в консоль
5. `test_log_error_operation_in_file_for_get_mask_card_number_with_log_decorator` - проверяет логирование ошибок в файл
6. `test_log_error_operation_in_console_for_get_mask_card_number_with_log_decorator` - проверяет логирование ошибок в консоль
7. `test_log_error_operation_in_file_for_filter_by_state_with_log_decorator` - проверяет логирование ошибок фильтрации в файл
8. `test_log_error_operation_in_console_for_filter_by_state_with_log_decorator` - проверяет логирование ошибок фильтрации в консоль

#### Тестирование работы с файлами транзакций:
1. `test_get_transactions_from_csv_for_get_transactions_from_csv` - проверяет чтение транзакций из CSV-файла:
   - Корректное чтение и преобразование данных
   - Проверка параметров чтения (разделитель ";", кодировка UTF-8)
2. `test_file_not_found_for_get_transactions_from_csv` - проверяет обработку отсутствия CSV-файла:
   - Корректное возбуждение FileNotFoundError
   - Проверка текста сообщения об ошибке
3. `test_empty_csv_file_for_get_transactions_from_csv` - проверяет обработку пустого CSV-файла:
   - Возврат пустого списка для пустого файла
4. `test_get_transactions_from_xlsx_for_get_transactions_from_xlsx` - проверяет чтение транзакций из XLSX-файла:
   - Корректное чтение и преобразование данных
   - Проверка чтения первого листа файла
5. `test_file_not_found_for_get_transactions_from_xlsx` - проверяет обработку отсутствия XLSX-файла:
   - Корректное возбуждение FileNotFoundError
   - Проверка текста сообщения об ошибке
6. `test_empty_xlsx_file_for_get_transactions_from_xlsx` - проверяет обработку пустого XLSX-файла:
   - Возврат пустого списка для пустого файла

#### Тесты для process_bank_search
1. `test_return_filtered_operation_for_process_bank_search`
    - проверяет корректность фильтрации операций по различным строкам поиска
2. `test_empty_out_data_for_process_bank_search`
    - проверяет обработку случая, когда совпадений не найдено
3. `test_not_description_in_dict_for_process_bank_search`
    - проверяет обработку операций без поля description
4. `test_args_in_incorrect_type_for_process_bank_search`
    - проверяет обработку некорректных типов входных данных
5. `test_input_empty_list_for_process_bank_search`
    - проверяет обработку пустого списка операций

#### Тесты для process_bank_operations
1. `test_group_operations_by_category_for_process_bank_operations`
    - проверяет корректность группировки операций по категориям
2. `test_input_empty_operations_list_for_process_bank_operations`
    - проверяет обработку пустого списка операций
3. `test_args_in_incorrect_type_for_process_bank_operations`
    - проверяет обработку некорректных типов входных данных
4. `test_not_description_in_dict_for_process_bank_operations`
    - проверяет обработку операций без поля description

#### Тесты для main
`test_print_filtered_operation`
- проверяет вывод отфильтрованных операций в различных сценариях:
    - Без сортировки по дате
    - С сортировкой по дате
    - С фильтрацией по валюте
    - С фильтрацией по описанию
    - С пустыми результатами после фильтрации

### Покрытие тестами
Для проверки покрытия кода тестами используйте:
```
pytest --cov=src --cov-report=html
```
Отчет будет сгенерирован в директории `htmlcov/`

## Работа с функциями
### get_mask_card_number (masks.py)
- Маскирует номер карты
- Принимает 16-ти значный номер карты
```
Пример входных данных (int)
1523523680955570
```
- Возвращает первые 6 и последние 4 цифры. Остальные скрывает под "*"
```
Пример возвращаемых данных (str)
1523 52** **** 5570
```
### get_mask_account (masks.py)
- Маскирует номер счёта
- Принимает 20-ти значный номер счёта
```
Пример входных данных (int)
74415234582962356289
```
- Возвращает последние 4 цифры счёта и перед ними 2 знака "*"
```
Пример возвращаемых данных (str)
**6289
```
### mask_account_card (widget.py)
- Маскирует строку с номером карты или счёта
- Принимает строку с типом и номером карты или счёта
```
Пример входных данных (str)
Visa Platinum 7000792289606361
Счет 73654108430135874305
```
- Возвращает строку с замаскированным номером
```
Пример возвращаемых данных (str)
Visa Platinum 7000 79** **** 6361
Счет **4305
```
### get_date (widget.py)
- Меняет форматирование у строки с датой на вид "ДД.ММ.ГГГГ"
- Принимает строку с датой
```
Пример входных данных (str)
"2024-03-11T02:26:18.671407"
```
- Возвращает отформатированную строку с датой
```
Пример возвращаемых данных (str)
"11.03.2024"
```
### filter_by_state (processing)
- Фильтрует список словарей по значению ключа "state".
- Принимает список словарей. Опционально может принимать строку со значением для ключа "state". Значение "state" по умолчанию - "EXECUTED" 
```
Пример входных данных (list[dict])
[
    {'id': 41428829, 'state': 'EXECUTED', 'date': '2019-07-03T18:35:29.512364'},
    {'id': 939719570, 'state': 'EXECUTED', 'date': '2018-06-30T02:08:58.425572'},
    {'id': 594226727, 'state': 'CANCELED', 'date': '2018-09-12T21:27:25.241689'},
    {'id': 615064591, 'state': 'CANCELED', 'date': '2018-10-14T08:21:33.419441'}
]
```
- Возвращает список словарей, содержащий только те словари, у которых ключ "state" соответствует указанному значению
```
Пример возвращаемых данных (list[dict)
выход функции со статусом по умолчанию 'EXECUTED'
[
    {'id': 41428829, 'state': 'EXECUTED', 'date': '2019-07-03T18:35:29.512364'}, 
    {'id': 939719570, 'state': 'EXECUTED', 'date': '2018-06-30T02:08:58.425572'}
]

выход функции, если вторым аргументов передано 'CANCELED'
[
    {'id': 594226727, 'state': 'CANCELED', 'date': '2018-09-12T21:27:25.241689'}, 
    {'id': 615064591, 'state': 'CANCELED', 'date': '2018-10-14T08:21:33.419441'}
]
```
### sort_by_date (processing)
- Сортирует список словарей по дате
- Принимает список словарей и необязательный параметр, задающий порядок сортировки (по умолчанию — убывание)
```
Пример входных данных (list[dict])
[
    {'id': 41428829, 'state': 'EXECUTED', 'date': '2019-07-03T18:35:29.512364'},
    {'id': 939719570, 'state': 'EXECUTED', 'date': '2018-06-30T02:08:58.425572'},
    {'id': 594226727, 'state': 'CANCELED', 'date': '2018-09-12T21:27:25.241689'}, 
    'id': 615064591, 'state': 'CANCELED', 'date': '2018-10-14T08:21:33.419441'}
]
```
- Возвращает список словарей, отсортированный по дате (по ключу "date")
```
Пример возвращаемых данных (list[dict)
выход функции (сортировка по убыванию, т. е. сначала самые последние операции)
[
    {'id': 41428829, 'state': 'EXECUTED', 'date': '2019-07-03T18:35:29.512364'},
    {'id': 615064591, 'state': 'CANCELED', 'date': '2018-10-14T08:21:33.419441'},
    {'id': 594226727, 'state': 'CANCELED', 'date': '2018-09-12T21:27:25.241689'},
    {'id': 939719570, 'state': 'EXECUTED', 'date': '2018-06-30T02:08:58.425572'}
]
```
### filter_by_currency (generators)
- Фильтрует транзакции по указанной валюте
- Принимает список словарей с транзакциями и код валюты (например "USD")
```
Пример входных данных (list[dict]):
[
    {
        "id": 939719570,
        "operationAmount": {
            "currency": {"name": "USD"}
        }
    },
    {
        "id": 142264268,
        "operationAmount": {
            "currency": {"name": "EUR"}
        }
    }
]
```
- Возвращает итератор по транзакциям в указанной валюте
```
Пример использования:
for transaction in filter_by_currency(transactions, "USD"):
    print(transaction)
```
### transaction_descriptions (generators)
- Извлекает описания транзакций
- Принимает список словарей с транзакциями
```
Пример входных данных (list[dict]):
[
    {"description": "Перевод организации"},
    {"id": 142264268},  # Без описания
    {"description": "Перевод со счета на счет"}
]
```
- Возвращает итератор по строкам с описаниями (пропускает транзакции без описания)
```
Пример использования:
for desc in transaction_descriptions(transactions):
    print(desc)
```
### card_number_generator (generators)
- Генерирует номера карт в заданном диапазоне
- Принимает начальный и конечный номера (целые числа)
```
Пример вызова:
card_number_generator(1, 3)
```
- Возвращает итератор по строкам с номерами карт в формате "XXXX XXXX XXXX XXXX"
```
Пример выходных данных:
"0000 0000 0000 0001"
"0000 0000 0000 0002"
"0000 0000 0000 0003"
```
### log (decorators.py)
- Декоратор для логирования результатов выполнения функций
```
Пример использования:
@log("mylog.txt") # Логи в файл
def some_function():
pass

@log() # Логи в консоль
def another_function():
pass
```
- Параметры:
  - `filename`: str | None - имя файла для записи логов (должно быть 'файл.txt' или None)
- Возможности:
  - Логирует успешное выполнение функций
  - Логирует ошибки с информацией об исключении и входных данных
  - Поддерживает запись как в файл, так и вывод в консоль
  - Сохраняет оригинальное имя и docstring обернутой функции
- Особенности:
  - Файлы логов создаются в директории `data/logs` относительно расположения скрипта
  - Для ошибок дополнительно записывает информацию об исключении и входных данных
### get_transactions_from_csv (transactions_from_files.py)
- Читает транзакции из CSV-файла
- Принимает путь к CSV-файлу (разделитель - точка с запятой, кодировка UTF-8)
```
Пример вызова:
get_transactions_from_csv("data/transactions.csv")
```
- Возвращает список словарей с транзакциями
```
Пример возвращаемых данных (list[dict]):
[
{"id": 1, "amount": 100, "currency": "USD"},
{"id": 2, "amount": 200, "currency": "EUR"}
]
```
- Исключения:
  - FileNotFoundError: если файл не найден
- Особенности:
  - Возвращает пустой список для пустого файла
  - Автоматически преобразует DataFrame в список словарей

### get_transactions_from_xlsx (transactions_from_files.py)
- Читает транзакции из Excel-файла (XLSX)
- Принимает путь к XLSX-файлу
```
Пример вызова:
get_transactions_from_xlsx("data/transactions.xlsx")
```
- Возвращает список словарей с транзакциями
```
Пример возвращаемых данных (list[dict]):
[
{"id": 1, "amount": 100, "currency": "USD"},
{"id": 2, "amount": 200, "currency": "EUR"}
]
```
- Исключения:
  - FileNotFoundError: если файл не найден
  - ValueError: при ошибках чтения Excel-файла
- Особенности:
  - Читает первый лист файла
  - Возвращает пустой список для пустого файла
  - Поддерживает только формат XLSX

#### process_bank_search
```python
def process_bank_search(data: list[dict], search: str) -> list[dict]
```
- Фильтрует банковские операции по совпадению строки поиска в описании операции.

Параметры:
- data (list[dict]): Список словарей с банковскими операциями. Каждая операция должна содержать поле 'description' (описание операции) и 'id' (идентификатор операции).
- search (str): Строка для поиска в описаниях операций. Поиск выполняется по подстроке без учета регистра.

Возвращает:
- list[dict]: Отфильтрованный список операций, где в описании найдено совпадение с search. Возвращает пустой список, если совпадений нет или входной список data пуст.

Исключения:
- TypeError: Если входные параметры не соответствуют ожидаемым типам или не переданы.

Пример использования:
```python
operations = [
    {"id": 1, "description": "Перевод организации"},
    {"id": 2, "description": "Перевод с карты на карту"}
]
filtered = process_bank_search(operations, "организации")
# Результат: [{"id": 1, "description": "Перевод организации"}]
```

### process_bank_operations
```python
def process_bank_operations(data: list[dict], categories: list) -> dict
```
- Обрабатывает банковские операции, подсчитывая количество операций по заданным категориям.

Параметры:
- data (list[dict]): Список словарей с банковскими операциями.
- categories (list): Список категорий для фильтрации операций.

Возвращает:
- dict: Словарь, где ключи - категории, а значения - количество операций в каждой категории.

Исключения:
- TypeError: Если входные параметры не соответствуют ожидаемым типам или не переданы.

Пример использования:
```python
python
operations = [
    {"id": 1, "description": "Перевод организации"},
    {"id": 2, "description": "Перевод с карты на карту"}
]
stats = process_bank_operations(operations, ["Перевод организации"])
# Результат: {"Перевод организации": 1}
```

### main
```python
def main() -> None
```
- Основная функция программы для работы с банковскими транзакциями.

Функционал:
- Интерактивный интерфейс для:
- Выбора источника данных (JSON/CSV/XLSX)
- Фильтрации транзакций по статусу
- Сортировки по дате
- Фильтрации по валюте
- Поиска по описанию
- Форматированного вывода результатов

Особенности:
- Интерактивное меню с валидацией ввода
- Поддержка нескольких форматов исходных данных
- Многоступенчатая фильтрация транзакций
- Форматированный вывод результатов
- Обработка всех возможных ошибок ввода

Пример использования:
```python
if __name__ == "__main__":
    main()
```
